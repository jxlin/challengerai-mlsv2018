Aichallenger

У нас был Артур, его девбокс, куча идей и огромное желание побеждать. Казалось этого достаточно, что бы пошатнуть любой kaggle, но китайская платформа оказалась крепким орешком.

## Описание задачи
Необходимо было классифицировать короткие видео, где каждое видео могло иметь более одного тега. Задача имела несколько особенностей.

1. Налагались ограничения на скорость и точность предсказания.
2. Данных было много.
3. Большая часть видео имела только один тег.
4. Все было на китайском.

Первый пункт был самый интересный, во-первых, не сразу стало ясно, на каком железе будет все считаться, во-вторых, ограничения по скорости так же включали в себя чтение видео. Таким образом можно было выделить две критичные части будущего решения: оптимизированное декодирование видео и сверточная сеть. Забегая вперед, скажу, что мы не уделили первой части должного внимания, за что и поплатились, но об этом ниже.

Предсказать нужно было следующие классы:

标签ID | 标签名称 | Tag Name | 标签ID | 标签名称 | Tag Name | 标签ID | 标签名称 | Tag Name |
--- | --- | --- | --- |--- | --- | --- | --- | --- |
0 | 狗 | Dog | 21 | 芭蕾舞 | Ballet | 42 | 游戏 | Games |
1 | 猫 | Cat | 22 | 广场舞 | Square Dancing | 43 | 娱乐 | Entertainment |
2 | 鼠 | Mouse | 23 | 民族舞 | Folk Dance | 44 | 动漫 | Animation |
3 | 兔子 | Rabbit | 24 | 绘画 | Drawing | 45 | 文字艺术配音 | Word Art Voicing |
4 | 鸟 | Bird | 25 | 手写文字 | Handwriting | 46 | 瑜伽 | Yoga |
5 | 风景 | Scenery | 26 | 咖啡拉花	 | Latte Art | 47 | 健身 | Fitness |
6 | 风土人情 | Local Customs | 27 | 沙画 | Sand Drawing | 48 | 滑板 | Skateboard |
7 | 穿秀 | Dressing | 28 | 史莱姆 | Slime | 49 | 篮球 | Basketball |
8 | 宝宝 | Baby | 29 | 折纸 | Origami | 50 | 跑酷 | Parkour |
9 | 男生自拍 | Selfie-Male | 30 | 编织 | Knitting | 51 | 潜水 | Diving |
10 | 女生自拍	 | Selfie-Female | 31 | 发饰 | Hair Accessory | 52 | 台球 | Billiards |
11 | 做甜品 | Dessert Making | 32 | 陶艺 | Pottery | 53 | 足球 | Football |
12 | 做海鲜 | Seafood Making | 33 | 手机壳 | Phone Case | 54 | 羽毛球 | Badminton |
13 | 街边小吃	 | Streetside Snacks | 34 | 打鼓 | Drums | 55 | 乒乓球 | Table Tennis |
14 | 饮品 | Drinks | 35 | 弹吉他 | Guitar | 56 | 画眉 | Brow Painting |
15 | 火锅 | Hot Pot | 36 | 弹钢琴 | Piano | 57 | 画眼 | Eyeliner |
16 | 抓娃娃 | Claw Crane | 37 | 弹古筝 | Guzheng | 58 | 护肤 | Skincare |
17 | 手势舞 | Handsign Dance | 38 | 拉小提琴 | Violin | 59 | 唇彩 | Lipgloss |
18 | 街舞 | Street Dance | 39 | 拉大提琴	| Cello | 60 | 卸妆 | Makeup Removal |
19 | 国标舞 | International Dance | 40 | 吹葫芦丝	 | Hulusi | 61 | 美甲 | Nail Cosmetic |
20 | 钢管舞 | Pole Dance | 41 | 唱歌 | Singing | 62 | 美发 | Hair Cosmetic |

В качестве метрики использовался усредненный по всем классам индекс Джаккарда (Average Jaccard Index), который определяется как отношение площади пересечения к площади объединения. 

### Данные
Организаторы предоставили train и validation set, в первом было 125368 файлов, а во втором 30736 соответсвенно. !! Добавить инфу по тегам!!
 
 ### Сабмит решения
 Решение нужно было отправлять в виде докер файла. Пример с описанием и базовым API [предоставили](https://github.com/AIChallenger/AI_Challenger_2018/tree/master/Evaluation/short_video_real_time_classification_eval]) организаторы. В итоге, участникам было необходимо дописать [infer.py](https://github.com/AIChallenger/AI_Challenger_2018/blob/master/Evaluation/short_video_real_time_classification_eval/mxnet/infer/infer.py), следуя предоставленному API. Давалось 3 попытки сабмита в неделю. ЛБ состоял из теста А и Б, при этом докер тестировался только на тесте А, тест Б открывался за 3 дня до конца соревнования и к нему допустались только те участники, решение которых укладывалось в ограничения по точности и скорости. На тест Б можно было отправить два решения, и результаты раскрывались только по окончанию соревнования. 6 первых команд по тесту Б приглашались в Пекин для очной презентации.

## Baseline
Начать мы попытались с довольно стандартной схемы для multi-label classification. Мы взяли opencv для чтения видео, seresnext50_32x4d как базовую сеть для классификации и BCEWithLogitsLoss. И тут же столкнулись с проблемами.
![](https://habrastorage.org/webt/ie/4f/_c/ie4f_cnale4hqugbi5i_9alxq7k.png)

Оказалось, что opencv для чтения видео - это очень медленно, а из-за жуткого дисбаланса классов, BCEWithLogitsLoss практически не дает какого-то либо стабильного и хорошего результата. Мы заменили opencv на PyAV и BCEWithLogitsLoss на обычную CrossEntropyLoss и предсказывали только 1 тег для каждого видео. Данное решение уже дало ~0.76 на ЛБ.

## Предпроцессинг и подготовка данных
Наш baseline был достаточно простым, мы брали первый кадр каждого видео, применяли стандартные аугментации и подавали на вход сети, получив более менее стабильный результат решили попробовать брать первые N кадров из видео или T случайных кадров из видео. Второй вариант осказался более предпочтительным, т.к. если видео включало в себя несколько тегов, то объекты. соответсвующие этим тегам, могли находиться в разных временных промежутках. Была идея использовать аудио канал, но особенностью собранных данных была наложенная музыка, которая часто не имела ничего общего с происходящим.

## Наше решение

Мы не стали останавливаться на одной сетке, и накинули дополнительных классификаторов. В итоге, из видео извлекались 5 случайных кадров, сеть усредненное предсказание, извлекала фичи из них и подавала их на классификаторы. Для финального предсказания использовался voting.

Получив неплохой результат на validation данных, мы отправили решение и даже не вошли в ЛБ, так как не влезли в ограничение по скорости.


 ## Организация

Одним словом - ужасна.